"use strict";(self.webpackChunkvendure_admin=self.webpackChunkvendure_admin||[]).push([[343],{6343:(w,v,i)=>{i.r(v),i.d(v,{InvoicesModule:()=>f});var b=i(2703),l=i(734),c=i(5774),h=i(9312),g=i(5026),y=i(3078);var e=i(5220),s=i(4725),d=i(4225),C=i(1133),k=i(647);function I(u,t){if(1&u&&e.nrm(0,"vdr-dynamic-form-input",10),2&u){const r=e.XpG();e.Y8G("readonly",!1)("def",r.htmlFormInputConfigArgsDef)("control",r.form.get("templateString"))}}class m{constructor(t,r,n,o,a){this.formBuilder=t,this.dataService=r,this.changeDetector=n,this.notificationService=o,this.localStorageService=a,this.invoicePreviewLoading=!1,this.renderNow=!1,this.htmlFormInputConfigArgsDef={name:"templateString",type:"text",list:!1,required:!1,ui:{component:"html-editor-form-input"}},this.form=this.formBuilder.group({enabled:["enabled"],templateString:["templateString"],orderCode:[""]}),this.serverPath=(0,l.lr8)()}ngOnInit(){var t=this;return(0,c.A)(function*(){t.dataService.query(h.tP).mapStream(r=>r.invoiceConfig).subscribe(r=>{t.form.controls.enabled.setValue(r?.enabled),t.renderNow=!0,t.form.controls.templateString.setValue(r?.templateString)})})()}save(){var t=this;return(0,c.A)(function*(){try{if(t.form.dirty){const r=t.form.value,n=yield t.dataService.mutate(h.ZX,{input:{enabled:r.enabled,templateString:r.templateString}}),{upsertInvoiceConfig:o}=yield function S(u,t){const r="object"==typeof t;return new Promise((n,o)=>{const a=new y.Ms({next:p=>{n(p),a.unsubscribe()},error:o,complete:()=>{r?n(t.defaultValue):o(new g.G)}});u.subscribe(a)})}(n);t.form.controls.enabled.setValue(o.enabled),t.form.controls.templateString.setValue(o.templateString)}t.form.markAsPristine(),t.changeDetector.markForCheck(),t.notificationService.success("common.notify-update-success",{entity:"InvoiceConfig"})}catch{t.notificationService.error("common.notify-update-error",{entity:"InvoiceConfig"})}})()}testDownload(){var t=this;return(0,c.A)(function*(){try{const r=t.form.value.templateString,n=t.form.value.orderCode;t.invoicePreviewLoading=!0,t.changeDetector.markForCheck();const o=yield fetch(`${t.serverPath}/invoices/preview/${n}`,{headers:{...t.getHeaders(),"Content-Type":"application/json"},method:"POST",body:JSON.stringify({template:r})});if(!o.ok){const p=yield o.json();throw Error(p?.message)}const a=yield o.blob();yield t.downloadBlob(a,"test-invoice.pdf",!0)}catch(r){console.error(r),t.notificationService.error(r?.message)}t.invoicePreviewLoading=!1,t.changeDetector.markForCheck()})()}getHeaders(){const t={},r=this.localStorageService.get("activeChannelToken");r&&(t["vendure-token"]=r);const n=this.localStorageService.get("authToken");return n&&(t.authorization=`Bearer ${n}`),t}downloadBlob(t,r,n=!1){return(0,c.A)(function*(){const o=window.URL.createObjectURL(t),a=document.createElement("a");document.body.appendChild(a),a.setAttribute("hidden","true"),a.href=o,n||(a.download=r),a.setAttribute("target","_blank"),a.click()})()}static#e=this.\u0275fac=function(r){return new(r||m)(e.rXU(s.ok),e.rXU(l.uSP),e.rXU(e.gRc),e.rXU(l.JEu),e.rXU(l.sji))};static#t=this.\u0275cmp=e.VBU({type:m,selectors:[["invoices-component"]],decls:20,vars:7,consts:[[1,"page-block"],[1,"btn","btn-primary",3,"click","disabled"],[1,"form",3,"formGroup"],["label","Generate invoices on","for","enabled"],["type","checkbox","clrCheckbox","","formControlName","enabled"],["label","HTML template","for","templateString"],["formControlName","templateString","style","max-width: 100%;",3,"readonly","def","control",4,"ngIf"],["label","Order Code","for","enabled"],["type","text","clrInput","","formControlName","orderCode"],[1,"btn","btn-primary","preview-button",3,"click","disabled"],["formControlName","templateString",2,"max-width","100%",3,"readonly","def","control"]],template:function(r,n){if(1&r&&(e.j41(0,"div",0)(1,"vdr-page-block")(2,"vdr-action-bar")(3,"vdr-ab-right")(4,"button",1),e.bIt("click",function(){return n.save()}),e.EFF(5),e.nI1(6,"translate"),e.k0s()()()(),e.j41(7,"vdr-page-block")(8,"vdr-card")(9,"form",2)(10,"vdr-form-field",3)(11,"clr-checkbox-wrapper"),e.nrm(12,"input",4),e.k0s()(),e.j41(13,"vdr-form-field",5),e.DNE(14,I,1,3,"vdr-dynamic-form-input",6),e.k0s(),e.j41(15,"vdr-form-field",7)(16,"clr-input-container"),e.nrm(17,"input",8),e.k0s()(),e.j41(18,"button",9),e.bIt("click",function(){return n.testDownload()}),e.EFF(19," Preview Template "),e.k0s()()()()()),2&r){let o;e.R7$(4),e.Y8G("disabled",n.form.invalid||(null==(o=n.form.get("templateString"))?null:o.pristine)),e.R7$(),e.SpI(" ",e.bMT(6,5,"common.update")," "),e.R7$(4),e.Y8G("formGroup",n.form),e.R7$(5),e.Y8G("ngIf",n.renderNow),e.R7$(4),e.Y8G("disabled",n.invoicePreviewLoading)}},dependencies:[d.Jej,d.eAx,d.icl,d.Xu5,C.bT,s.qT,s.me,s.Zm,s.BC,s.cb,s.j4,s.JD,l.nGW,l.TXc,l.KSf,l.Vr5,l.eH4,l.iby,l.ba8,k.D9],styles:["button.preview-button[_ngcontent-%COMP%]{margin-top:1em!important}"]})}class f{static#e=this.\u0275fac=function(r){return new(r||f)};static#t=this.\u0275mod=e.$C({type:f});static#r=this.\u0275inj=e.G2t({imports:[l.GgS,b.iI.forChild([{path:"",pathMatch:"full",component:m,data:{breadcrumb:"Invoices"}}])]})}}}]);
//# sourceMappingURL=343.e8f96f8b2b99eeea.js.map